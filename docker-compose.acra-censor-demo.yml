version: "3"

services:
    #===== Acra ================================================================
    acra-server:
        image: "cossacklabs/acra-server:${ACRA_DOCKER_IMAGE_TAG:-0.95.0}"
        # Restart server after correct termination, for example after the config
        # was changed through the API
        restart: always
        networks:
            - mutillidae-acraserver
            - acraserver-db
        environment:
            ACRA_MASTER_KEY: ${ACRA_MASTER_KEY:-UHZ3VUNNeTJ0SEFhbWVjNkt4eDdVYkc2WnNpUTlYa0E=}
        volumes:
            # Mount the directory with only the keys for this service. Must be
            # rewriteable in case of using API, otherwise should be read-only.
            # Directory with configuration, rewriteable
            - ./.acraconfigs/acra-server:/config
        command: >-
            --mysql_enable
            --db_host=database
            --db_port=3306
            --keystore_cache_on_start_enable=false
            --acracensor_config_file=/config/acra-censor.yaml
            --v
            --d

    #===== OWASP Mutillidae II =================================================

    mutillidae:
        container_name: mutillidae
        depends_on:
            - database
            - acra-server
        image: mutillidae
        build:
            context: https://github.com/webpwnized/mutillidae-docker.git#1.0.39:www
            args:
                DATABASE_HOST: acra-server
                DATABASE_PORT: 9393
        ports:
            - 127.0.0.1:8080:80
        networks:
            - world
            - mutillidae-acraserver

    #===== OWASP Mutillidae DB =================================================

    database:
        container_name: database
        image: webpwnized/mutillidae:database
        healthcheck:
            test: "/usr/bin/mysql --user=root --password=mutillidae --execute \"SHOW DATABASES;\""
            interval: 5s
            timeout: 30s
            retries: 10
        build:
            context: https://github.com/webpwnized/mutillidae-docker.git#1.0.39:database
        networks:
            - acraserver-db

    healthcheck-wait:
        image: busybox
        container_name: healthcheck-wait
        depends_on:
            database:
                condition: service_healthy

networks:
    world:
    acraserver-db:
        internal: true
    mutillidae-acraserver:
        internal: true
    mutillidae-db:
        internal: true
